<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Scientific Literature → JSON Extraction</title>
  <style>
    body { font-family: system-ui; max-width: 980px; margin: 40px auto; padding: 0 16px; }
    textarea, input, select { width: 100%; }
    textarea { min-height: 110px; }
    pre { background: #f6f8fa; padding: 12px; border-radius: 10px; overflow:auto; }
    .row { display:flex; gap:12px; flex-wrap:wrap; align-items: end; }
    button { padding: 10px 14px; cursor:pointer; }
    input[type="file"] { padding: 8px; }
    .card { border: 1px solid #e5e7eb; border-radius: 12px; padding: 14px; margin-top: 12px; }
    small { color: #555; }
    .pill { display:inline-block; padding: 2px 8px; border-radius: 999px; background:#eef2ff; font-size:12px; }
    label small { display:block; margin-bottom:6px; }
  </style>
</head>
<body>
  <h1>Scientific Literature → JSON Extractor</h1>
  <p>
    <small class="pill">Frontend: GitHub Pages</small>
    <small class="pill">Backend: Vercel API</small>
  </p>

  <div class="card">
    <h3>1) Choose a PDF</h3>
    <div class="row">
      <div style="flex:2; min-width:280px;">
        <small>PDF file</small>
        <input id="pdf" type="file" accept="application/pdf" />
      </div>
      <div style="flex:1; min-width:220px;">
        <button id="loadBtn" style="width:100%;">Load PDF Text</button>
      </div>
    </div>

    <p><small id="status">No PDF loaded.</small></p>

    <details>
      <summary><small>Preview extracted text (first ~2000 chars)</small></summary>
      <pre id="preview"></pre>
    </details>
  </div>

  <div class="card">
    <h3>2) Extraction instruction</h3>
    <textarea id="query">Extract mentions of materials and the properties they have which are mentioned in the abstract.</textarea>

    <h3 style="margin-top:14px;">3) JSON Schema</h3>
    <textarea id="schema">
{
  "type": "object",
  "properties": {
    "items": {
      "type": "array",
      "items": {
        "type": "object",
        "properties": {
          "material": { "type": "string" },
          "properties": { "type": "array", "items": { "type": "string" } },
          "evidence": { "type": "array", "items": { "type": "string" } }
        },
        "required": ["material", "properties"]
      }
    }
  },
  "required": ["items"]
}
    </textarea>

    <h3 style="margin-top:14px;">4) Model</h3>
    <div class="row">
      <label style="flex:1; min-width:220px;">
        <small>Provider</small>
        <select id="provider" style="padding:10px;">
          <option value="openai">OpenAI</option>
          <option value="anthropic">Claude (Anthropic)</option>
          <option value="gemini">Gemini (Google)</option>
          <option value="deepseek">DeepSeek</option>
        </select>
      </label>

      <label style="flex:2; min-width:280px;">
        <small>Model (optional)</small>
        <input id="model" placeholder="Leave blank to use default for provider" style="padding:10px;" />
      </label>
    </div>

    <div class="row" style="margin-top:12px;">
      <button id="runBtn" style="flex:1; min-width:220px;">Run Extraction</button>
      <button id="downloadBtn" style="flex:1; min-width:220px;">Download JSON</button>
    </div>
  </div>

  <div class="card">
    <h3>Result (JSON)</h3>
    <pre id="out">{}</pre>
  </div>

  <script type="module">
    const API_BASE = "https://wajahathssn-github-io.vercel.app/api";

    let pdfText = "";
    const statusEl = document.getElementById("status");
    const previewEl = document.getElementById("preview");
    const outEl = document.getElementById("out");

    async function pdfToText(file) {
      const arrayBuffer = await file.arrayBuffer();
      const pdfjsLib = await import("https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.4.168/pdf.min.mjs");
      pdfjsLib.GlobalWorkerOptions.workerSrc =
        "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.4.168/pdf.worker.min.mjs";

      const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;

      let text = "";
      for (let i = 1; i <= pdf.numPages; i++) {
        const page = await pdf.getPage(i);
        const content = await page.getTextContent();
        const pageText = content.items.map(it => it.str).join(" ");
        text += `\n\n[Page ${i}]\n${pageText}`;
      }
      return text.trim();
    }

    document.getElementById("loadBtn").onclick = async () => {
      try {
        const f = document.getElementById("pdf").files[0];
        if (!f) return alert("Choose a PDF first.");

        statusEl.textContent = "Extracting text from PDF in the browser...";
        pdfText = await pdfToText(f);

        previewEl.textContent = pdfText.slice(0, 2000) + (pdfText.length > 2000 ? "\n\n...[truncated]" : "");
        statusEl.textContent = `Loaded PDF text (${pdfText.length.toLocaleString()} characters). Ready to run extraction.`;
      } catch (e) {
        console.error(e);
        statusEl.textContent = "Failed to extract PDF text.";
        alert("Failed to extract PDF text. Try a different PDF or smaller file.");
      }
    };

    document.getElementById("runBtn").onclick = async () => {
      try {
        if (!pdfText) return alert("Load PDF text first (click 'Load PDF Text').");

        const query = document.getElementById("query").value.trim();
        if (!query) return alert("Enter an extraction instruction.");

        let schema;
        try {
          schema = JSON.parse(document.getElementById("schema").value);
        } catch {
          return alert("Schema is not valid JSON.");
        }

        const provider = document.getElementById("provider").value;
        const modelInput = document.getElementById("model").value.trim();

        outEl.textContent = "Calling backend...";

        const prompt = `DOCUMENT TEXT:\n${pdfText}\n\nTASK:\n${query}`;

        const r = await fetch(`${API_BASE}/extract_json`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            provider,
            model: modelInput || undefined,
            prompt,
            schema
          })
        });

        const data = await r.json();

        if (!r.ok) {
          outEl.textContent = JSON.stringify(data, null, 2);
          return;
        }

        // backend returns { ok, provider, model, result }
        outEl.textContent = JSON.stringify(data, null, 2);
      } catch (e) {
        console.error(e);
        outEl.textContent = JSON.stringify({ error: String(e?.message || e) }, null, 2);
      }
    };

    document.getElementById("downloadBtn").onclick = () => {
      const text = outEl.textContent || "{}";
      const blob = new Blob([text], { type: "application/json" });
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = "extraction-result.json";
      a.click();
      URL.revokeObjectURL(a.href);
    };
  </script>
</body>
</html>
